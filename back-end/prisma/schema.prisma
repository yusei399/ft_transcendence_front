generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId   Int  @id @default(autoincrement())
  user42Id Int? @unique
  email     String
  password  String?

  profile Profile? @relation("profile")

  sentInvitations     Invitation[] @relation("SentInvitations")
  receivedInvitations Invitation[] @relation("ReceivedInvitations")

  FriendsProfile Profile[] @relation("friends")
  chatParticipations ChatParticipation[]
  gameParticipations GameParticipation[]

  @@map("Users")
}

model Profile {
  profileId Int @id @default(autoincrement())
  userId Int @unique
  user User @relation("profile", fields: [userId], references: [userId])
  nickname  String? @unique
  avatarUrl String?
  friends User[] @relation("friends")
}

model Invitation {
  invitationId Int @id @default(autoincrement())

  senderId   Int
  receiverId Int
  sender     User @relation("SentInvitations", fields: [senderId], references: [userId])
  receiver   User @relation("ReceivedInvitations", fields: [receiverId], references: [userId])

  status InvitationStatus @default(PENDING)
  kind   InvitationKind

  targetChatId Int?
  targetChat   Chat? @relation(fields: [targetChatId], references: [chatId])

  targetGameId Int?
  targetGame   Game?

  @@map("Invitations")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REFUSED
  CANCELED
}

enum InvitationKind {
  FRIEND
  CHAT
  GAME
}

model Chat {
  chatId Int @id @default(autoincrement())

  name          String?
  chatAvatarUrl String?
  password      String?

  invitations  Invitation[]
  participants ChatParticipation[]

  @@map("Chats")
}

model Message {
  messageId Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  chatParticipationId Int
  chatParticipation   ChatParticipation @relation(fields: [chatParticipationId], references: [chatParticipationId])
  messageContent      String

  @@map("Messages")
}

model ChatParticipation {
  chatParticipationId Int       @id @default(autoincrement())
  role                Role      @default(MEMBER)
  mutedUntil          DateTime?
  blockedUntil        DateTime?

  messages Message[]

  chatId Int
  chat   Chat @relation(fields: [chatId], references: [chatId])

  userId Int
  user   User @relation(fields: [userId], references: [userId])

  @@unique([chatId, userId])
  @@map("ChatParticipations")
}

enum Role {
  CREATOR
  ADMIN
  MEMBER
}

model GameParticipation {
  GameParticipationId Int @id @default(autoincrement())

  Point    Int      @default(0)
  isWinner Boolean?

  gameId Int
  game   Game @relation(fields: [gameId], references: [gameId])

  userId Int
  user   User @relation(fields: [userId], references: [userId])

  @@map("GameParticipations")
}

model Game {
  gameId Int @id @default(autoincrement())

  scoreToWin Int        @default(3)
  gameStatus GameStatus @default(WAITING_FOR_PLAYER)

  playerOnePaddlePos Int @default(0)
  playerTwoPaddlePos Int @default(0)

  ballPositionX Int @default(0)
  ballPositionY Int @default(0)

  invitationId Int                 @unique
  invitation   Invitation          @relation(fields: [invitationId], references: [invitationId])
  participants GameParticipation[]

  @@map("Games")
}

enum GameStatus {
  WAITING_FOR_PLAYER
  IN_PROGRESS
  PAUSED
  FINISHED
  CANCELED
}
